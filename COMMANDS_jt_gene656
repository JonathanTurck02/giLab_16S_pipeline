#GENE_656 Commands JT

#doing this into the q10 files
# create manifest in the q10 directory

# manifest prep
sed s/'-Danila'// manifest.txt  | sed s/'-16Sv3v4'// | cut -f 3-9 -d'-' > fixed_manifest.txt
# this removes the 'sample-' in line one so I manually added it back

# load qiime-amplicon distro
module purge
module load Anaconda3/2023.07-2
source activate /sw/hprc/sw/Anaconda3/2023.07-2/envs/qiime2-2024.2-amplicon


# import sequences w/ manifest
qiime tools import \
  --type 'SampleData[PairedEndSequencesWithQuality]' \
  --input-path fixed_manifest.txt \
  --output-path mousev3v4_Spring2024_paired-end-demux.qza \
  --input-format PairedEndFastqManifestPhred33

# make visualization
qiime demux summarize \
  --i-data mousev3v4_Spring2024_paired-end-demux.qza \
  --o-visualization mousev3v4_Spring2024_paired-end-demux.qzv

# ran denoise with job
qiime metadata tabulate \
  --m-input-file mousev3v4_Spring2024_denoising_stats.qza \
  --o-visualization mousev3v4_Spring2024_denoising_stats.qzv

# ran grace_classify.job

qiime metadata tabulate \
  --m-input-file qt10_mousev3v4_48_taxonomy.qza \
  --o-visualization qt10_mousev3v4_48_taxonomy.qzv

qiime feature-table filter-features \
  --i-table mousev3v4_Spring2024_table.qza \
  --p-min-samples 2 \
  --p-min-frequency 2 \
  --o-filtered-table min2min2_q10_mousev3v4_Spr24_table.qza

qiime feature-table summarize \
  --i-table min2min2_q10_mousev3v4_Spr24_table.qza \
  --o-visualization min2min2_mousev3v4_q10_Spr24_table.qzv

# Had issue with this command, skip step for now because this doesn't filter out much
qiime taxa filter-table \
  --i-table min2min2_q10_mousev3v4_Spr24_table.qza \
  --i-taxonomy qt10_mousev3v4_48_taxonomy.qza \
  --p-include c__ \
  --p-exclude Mitochondria,Chloroplast \
  --o-filtered-table filtered_q10_mousev3v4_Spr24_table.qza

qiime feature-table summarize \
  --i-table min2min2_q10_mousev3v4_Spr24_table.qza \
  --o-visualization filtered_mousev3v4_Spr24_table.qzv

qiime taxa barplot \
  --i-table q10_mousev3v4_Spr24_table.qza \
  --i-taxonomy qt10_mousev3v4_48_taxonomy.qza \
  --m-metadata-file fulledit_metadata_q10_LEAD_DC.txt \
  --o-visualization qt10_mousev3v4_taxa_barplot.qza

### having issues with features not present in taxonomy, features to discard command
qiime feature-table filter-features \
  --i-table q10_mousev3v4_Spr24_table.qza \
  --m-metadata-file features_to_discard.txt \
  --p-exclude-ids \
  --o-filtered-table ftd_filtered_q10_mousev3v4_Spr24_table.qza

qiime taxa barplot \
  --i-table ftd_filtered_q10_mousev3v4_Spr24_table.qza \
  --i-taxonomy qt10_mousev3v4_48_taxonomy.qza \
  --m-metadata-file fulledit_metadata_q10_LEAD_DC.txt \
  --o-visualization qt10_mousev3v4_taxa_barplot.qzv

# core-metrics
qiime diversity core-metrics \
  --i-table ftd_filtered_q10_mousev3v4_Spr24_table.qza \
  --p-sampling-depth 15000 \
  --m-metadata-file fulledit_metadata_q10_LEAD_DC.txt \
  --p-n-jobs 4 \
  --output-dir core_metrics_out

# alpha-diversity significance
qiime diversity alpha \
  --i-table core_metrics_out/rarefied_table.qza \
  --p-metric chao1 \
  --o-alpha-diversity chao1_alphadiversity.qza

qiime diversity alpha-group-significance \
  --i-alpha-diversity chao1_alphadiversity.qza \
  --m-metadata-file fulledit_metadata_q10_LEAD_DC.txt \
  --o-visualization chao1_alpha_group_sig.qzv

qiime diversity alpha-group-significance \
  --i-alpha-diversity core_metrics_out/observed_features_vector.qza \
  --m-metadata-file fulledit_metadata_q10_LEAD_DC.txt \
  --o-visualization observed_features_alpha_group_sig.qzv

qiime diversity alpha-group-significance \
  --i-alpha-diversity core_metrics_out/shannon_vector.qza \
  --m-metadata-file fulledit_metadata_q10_LEAD_DC.txt \
  --o-visualization shannon_alpha_group_sig.qzv

# beta-diversity metrics
qiime feature-table filter-seqs \
  --i-data mousev3v4_Spring2024_rep-seqs.qza \
  --i-table ftd_filtered_q10_mousev3v4_Spr24_table.qza \
  --o-filtered-data filtered_seqs.qza

qiime phylogeny align-to-tree-mafft-fasttree --p-n-threads 6 \
  --i-sequences filtered_seqs.qza \
  --o-alignment aligned_seqs.qza \
  --o-masked-alignment masked_aligned_seqs.qza \
  --o-tree unrooted.qza  \
  --o-rooted-tree rooted.qza

qiime diversity beta-phylogenetic \
  --i-table ftd_filtered_q10_mousev3v4_Spr24_table.qza \
  --i-phylogeny rooted.qza \
  --p-metric weighted_unifrac \
  --p-bypass-tips True \
  --o-distance-matrix weighted_unifrac_matrix.qza


# remove strain 006
qiime feature-table filter-samples \
 --i-table ftd_filtered_q10_mousev3v4_Spr24_table.qza \
 --m-metadata-file samples_to_keep.txt \
 --o-filtered-table id-filtered-table.qza

# repeat barplot w/ CC006 removed
qiime taxa barplot \
  --i-table id-filtered-table.qza \
  --i-taxonomy qt10_mousev3v4_48_taxonomy.qza \
  --m-metadata-file fixed_minusCC006_metadata.txt \
  --o-visualization qt10_minusCC006_taxa_barplot.qzv

# rerun core-metrics
qiime diversity core-metrics \
  --i-table id-filtered-table.qza \
  --p-sampling-depth 15000 \
  --m-metadata-file fixed_minusCC006_metadata.txt \
  --p-n-jobs 4 \
  --output-dir minusCC006_core_metrics_out

# adonis
qiime diversity adonis \
  --i-distance-matrix minusCC006_core_metrics_out/jaccard_distance_matrix.qza \
  --m-metadata-file fixed_minusCC006_metadata.txt \
  --p-formula "Strain+Diet+Strain*Diet" \
  --p-n-jobs 4 \
  --o-visualization Strain_Diet_jaccard_adonis 

####ANCOM###########
#make list files:
grep -v Ch fixed_minusCC006_metadata.txt > Am_fixed_minusCC006_metadata.txt
grep -v Am fixed_minusCC006_metadata.txt > Ch_fixed_minusCC006_metadata.txt

qiime feature-table filter-samples \
  --i-table ftd_filtered_q10_mousev3v4_Spr24_table.qza \
  --m-metadata-file Ch_fixed_minusCC006_metadata.txt \
  --o-filtered-table Ch_LEAD_table.qza

qiime feature-table filter-samples \
  --i-table ftd_filtered_q10_mousev3v4_Spr24_table.qza \
  --m-metadata-file Am_fixed_minusCC006_metadata.txt \
  --o-filtered-table Am_LEAD_table.qza

qiime taxa collapse \
  --i-table Ch_LEAD_table.qza \
  --i-taxonomy qt10_mousev3v4_48_taxonomy.qza \
  --p-level 6 \
  --o-collapsed-table collapsed6_Ch_LEAD_table.qza

qiime taxa collapse \
  --i-table Am_LEAD_table.qza \
  --i-taxonomy qt10_mousev3v4_48_taxonomy.qza \
  --p-level 6 \
  --o-collapsed-table collapsed6_Am_LEAD_table.qza

##ANCOM genus
##Ch
qiime composition add-pseudocount --i-table collapsed6_Ch_LEAD_table.qza --o-composition-table collapsed6_pseudo_Ch_LEAD_table.qza
qiime composition ancom --i-table collapsed6_pseudo_Ch_LEAD_table.qza --m-metadata-file Ch_fixed_minusCC006_metadata.txt --m-metadata-column Strain --o-visualization Strain_collapsed6_Ch_ancom.qzv

##Am
qiime composition add-pseudocount --i-table collapsed6_Am_LEAD_table.qza --o-composition-table collapsed6_pseudo_Am_LEAD_table.qza
qiime composition ancom --i-table collapsed6_pseudo_Am_LEAD_table.qza --m-metadata-file Am_fixed_minusCC006_metadata.txt --m-metadata-column Strain --o-visualization Strain_collapsed6_Am_ancom.qzv

